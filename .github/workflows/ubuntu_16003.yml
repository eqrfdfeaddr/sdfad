name: Install and Configure Cloudflared

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      custom_token:
        description: 'è‡ªå®šä¹‰ Cloudflare Token (ç•™ç©ºåˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼)'
        required: false
        type: string
        default: ''

jobs:
  setup-cloudflared:
    runs-on: ubuntu-latest
    # å®šä¹‰ç¯å¢ƒå˜é‡
    env:
      # ä¼˜å…ˆä½¿ç”¨ä»“åº“çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚æœæœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
      DEFAULT_CF_TOKEN: ""
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Cloudflared
        run: |
          # æ·»åŠ  Cloudflare GPG å¯†é’¥
          sudo mkdir -p --mode=0755 /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          
          # æ·»åŠ  Cloudflare è½¯ä»¶æº
          echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
          
          # å®‰è£… cloudflared
          sudo apt-get update && sudo apt-get install cloudflared

      - name: Configure Cloudflared Service
        # ä½¿ç”¨æ¥è‡ªç¯å¢ƒå˜é‡æˆ–æ‰‹åŠ¨è¾“å…¥çš„ token
        env:
          # ä¼˜å…ˆé¡ºåºï¼š1. æ‰‹åŠ¨è¾“å…¥ 2. ä»“åº“ç¯å¢ƒå˜é‡ 3. é»˜è®¤å€¼
          CF_TOKEN: ${{ github.event.inputs.custom_token || secrets.CLOUDFLARE_TOKEN || env.DEFAULT_CF_TOKEN }}
        run: |
          # ä½¿ç”¨æœ€ç»ˆç¡®å®šçš„ token
          echo "Installing cloudflared service with token (å‰10å­—ç¬¦): ${CF_TOKEN:0:10}..."
          
          # å®‰è£… cloudflared æœåŠ¡
          sudo cloudflared service install $CF_TOKEN
          
          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo "Cloudflared service status:"
          sudo systemctl status cloudflared || true
          
          # éªŒè¯æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
          if sudo systemctl is-active --quiet cloudflared; then
            echo "âœ… Cloudflared service started successfully"
          else
            echo "âŒ Cloudflared service failed to start"
            sudo systemctl status cloudflared
            exit 1
          fi

      - name: Keep Runner Active
        run: |
          echo "============================================="
          echo "ğŸ”„ Keep the GitHub Action runner active"
          echo "ğŸ“‹ Press 'Cancel workflow' to terminate manually"
          echo "============================================="
          
          # æ˜¾ç¤ºä¸€äº›æœ‰ç”¨çš„ç³»ç»Ÿä¿¡æ¯
          echo "ğŸ“… Current time: $(date)"
          echo "ğŸ–¥ï¸ Hostname: $(hostname)"
          echo "ğŸ”Œ Network interfaces:"
          ip -br addr
          
          echo "ğŸ“¡ Cloudflared connection info:"
          sudo cloudflared tunnel info || echo "Unable to get tunnel info"
          
          echo "============================================="
          echo "ğŸ” Keeping runner active with tail -f /etc/hosts"
          echo "============================================="
          
          # æŒ‚èµ· runner è¿›ç¨‹
          tail -f /etc/hosts
